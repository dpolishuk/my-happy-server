services:
    app:
        build: .
        image: happy-server:local
        ports:
            - "3005:3005"
            - "9091:9090"
        environment:
            - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/handy
            - REDIS_URL=redis://redis:6379
            - HANDY_MASTER_SECRET=your-super-secret-key-change-in-production
            - PORT=3005
            - NODE_ENV=production
            - METRICS_ENABLED=true
            - METRICS_PORT=9090
            - S3_HOST=minio
            - S3_PORT=9000
            - S3_USE_SSL=false
            - S3_ACCESS_KEY=minioadmin
            - S3_SECRET_KEY=minioadmin
            - S3_BUCKET=happy
            - S3_PUBLIC_URL=http://localhost:9000/happy
            - DANGEROUSLY_LOG_TO_SERVER_FOR_AI_AUTO_DEBUGGING=true
        volumes:
            - ./logs:/app/.logs
        depends_on:
            postgres-init:
                condition: service_completed_successfully
            redis:
                condition: service_healthy
            minio-init:
                condition: service_completed_successfully
        restart: unless-stopped

    postgres:
        image: postgres:16-alpine
        environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
            - POSTGRES_DB=handy
        volumes:
            - postgres_data:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 5s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    postgres-init:
        image: postgres:16-alpine
        depends_on:
            postgres:
                condition: service_healthy
        environment:
            - PGPASSWORD=postgres
        entrypoint: >
            /bin/sh -c "
            psql -h postgres -U postgres -c \"ALTER USER postgres WITH PASSWORD 'postgres';\" || true;
            echo 'PostgreSQL password configured';
            "

    redis:
        image: redis:7-alpine
        command: redis-server --appendonly yes
        volumes:
            - redis_data:/data
        ports:
            - "6379:6379"
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    minio:
        image: minio/minio
        command: server /data --console-address ":9001"
        environment:
            - MINIO_ROOT_USER=minioadmin
            - MINIO_ROOT_PASSWORD=minioadmin
        volumes:
            - minio_data:/data
        ports:
            - "9000:9000"
            - "9001:9001"
        healthcheck:
            test: ["CMD", "mc", "ready", "local"]
            interval: 5s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    minio-init:
        image: minio/mc
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            mc alias set myminio http://minio:9000 minioadmin minioadmin;
            mc mb -p myminio/happy || true;
            mc anonymous set download myminio/happy;
            echo 'Bucket created successfully';
            "

volumes:
    postgres_data:
    redis_data:
    minio_data:
